<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GORILLA WARFARE // COMMAND</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root {
            --bg-dark: #050505; --card-bg: rgba(15, 15, 20, 0.95);
            --border: rgba(255, 255, 255, 0.1); --accent: #8b5cf6; 
            --accent-glow: rgba(139, 92, 246, 0.4);
            --text: #ffffff; --dim: #666; --green: #10b981; --red: #ef4444;
            --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
        }
        * { cursor: default; box-sizing: border-box; }
        body { 
            background: #000; color: var(--text); font-family: var(--font-ui); margin: 0; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
        }

        /* --- TOP TELEMETRY BAR --- */
        #telemetry {
            height: 40px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; font-family: var(--font-code); font-size: 0.75em;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 10;
        }
        .stat-group { display: flex; gap: 20px; }
        .stat-item { display: flex; align-items: center; gap: 8px; color: var(--dim); }
        .stat-val { color: var(--accent); font-weight: bold; }
        .pulse-dot {
            width: 6px; height: 6px; background: var(--green);
            border-radius: 50%; box-shadow: 0 0 8px var(--green);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* --- LAYOUT --- */
        #workspace { display: flex; flex: 1; overflow: hidden; }
        
        #sidebar { 
            width: 260px; background: rgba(0,0,0,0.4); 
            border-right: 1px solid var(--border); padding: 25px;
            display: flex; flex-direction: column; gap: 10px;
        }

        #main-view { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* --- TERMINAL (BOTTOM) --- */
        #terminal {
            height: 150px; background: #080808; border-top: 1px solid var(--border);
            padding: 15px; font-family: var(--font-code); font-size: 0.8em;
            color: #ccc; overflow-y: auto; display: flex; flex-direction: column-reverse;
        }
        .log-entry { margin-bottom: 4px; border-left: 2px solid transparent; padding-left: 8px; }
        .log-info { border-color: var(--accent); color: #aaa; }
        .log-warn { border-color: var(--red); color: #faa; }
        .log-success { border-color: var(--green); color: #afa; }

        /* --- COMPONENTS --- */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
        .btn { 
            padding: 10px 18px; border: none; border-radius: 4px; 
            font-family: var(--font-code); font-size: 0.7em; letter-spacing: 1px;
            font-weight: 700; text-transform: uppercase; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.2); }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 0 15px rgba(139,92,246,0.2); }
        .btn-danger { background: rgba(239,68,68,0.1); border: 1px solid var(--red); color: var(--red); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: #888; }

        .nav-item {
            padding: 12px; border-radius: 6px; color: var(--dim); cursor: pointer;
            font-weight: 600; font-size: 0.85em; transition: 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: rgba(139,92,246,0.05); color: var(--accent); border-left-color: var(--accent); }

        .search-bar { 
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); 
            padding: 12px; color: white; font-family: var(--font-code); outline: none;
            margin-bottom: 20px;
        }

        /* --- INTEGRITY BAR --- */
        .integrity-container { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
        .integrity-label { font-size: 0.7em; color: var(--dim); margin-bottom: 5px; display:flex; justify-content:space-between; }
        .progress-bar { height: 4px; background: #222; border-radius: 2px; overflow: hidden; display: flex; }
        .bar-fill { height: 100%; background: var(--green); width: 100%; transition: width 0.5s; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(4px); }

        /* LISTS */
        .row-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 0.9em; transition: 0.2s;
        }
        .row-item:hover { background: rgba(255,255,255,0.02); }
        .tag { padding: 2px 6px; border-radius: 3px; font-size: 0.7em; font-weight: bold; }
        .tag-red { color: var(--red); background: rgba(239,68,68,0.1); }
        .tag-green { color: var(--green); background: rgba(16,185,129,0.1); }
    </style>
</head>
<body>

    <div id="telemetry" style="display:none;">
        <div class="stat-group">
            <div class="stat-item"><div class="pulse-dot"></div> <span id="sys-status">OFFLINE</span></div>
            <div class="stat-item">UPTIME: <span id="sys-uptime" class="stat-val">00:00:00</span></div>
        </div>
        <div class="stat-group">
            <div class="stat-item">RAM: <span id="sys-ram" class="stat-val">0 MB</span></div>
            <div class="stat-item">PING: <span id="sys-ping" class="stat-val">-- ms</span></div>
            <div class="stat-item" style="color:white; border-left:1px solid #333; padding-left:20px;" id="clock">00:00:00 UTC</div>
        </div>
    </div>

    <div id="login-screen">
        <div class="card" style="width: 350px; text-align: center; border-top: 3px solid var(--accent);">
            <h2 style="letter-spacing: -1px; margin-bottom: 5px;">GORILLA <span style="color:var(--accent)">CMD</span></h2>
            <p style="color: var(--dim); font-size: 0.8em; margin-bottom: 25px;">SECURE ACCESS TERMINAL</p>
            <input type="text" id="api-url" value="https://sanctionbanepiconlineservicesystem.onrender.com" class="search-bar" placeholder="SERVER TARGET">
            <input type="password" id="api-pass" class="search-bar" placeholder="ACCESS KEY">
            <button onclick="initSystem()" class="btn btn-primary" style="width:100%">ESTABLISH UPLINK</button>
            <p id="login-msg" style="color:var(--red); font-size:0.7em; margin-top:10px; font-family:var(--font-code);"></p>
        </div>
    </div>

    <div id="workspace" style="display:none;">
        <div id="sidebar">
            <div style="font-weight: 800; font-size: 1.2em; color: white; margin-bottom: 30px;">
                GW <span style="color:var(--accent)">ADMIN</span>
            </div>
            
            <div class="nav-item active" onclick="switchView('players')">PLAYER DATABASE</div>
            <div class="nav-item" onclick="switchView('backups')">TIME MACHINE</div>

            <div class="integrity-container">
                <div class="integrity-label"><span>SYSTEM INTEGRITY</span> <span id="integrity-pct">100%</span></div>
                <div class="progress-bar"><div id="integrity-bar" class="bar-fill"></div></div>
                <div style="font-size: 0.7em; color:var(--dim); margin-top: 5px;">BANNED: <span id="count-ban">0</span> / TOTAL: <span id="count-total">0</span></div>
            </div>
        </div>

        <div id="main-view">
            <div id="view-players" style="height:100%; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2>DATABASE RECORDS</h2>
                    <button onclick="refreshData()" class="btn btn-ghost">REFRESH</button>
                </div>
                <input type="text" id="p-search" onkeyup="renderPlayers()" class="search-bar" placeholder="QUERY DATABASE...">
                <div id="list-players" style="overflow-y:auto; flex:1; border:1px solid var(--border); border-radius:8px;"></div>
            </div>

            <div id="view-backups" style="display:none; height:100%; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2>TIME MACHINE</h2>
                    <button onclick="createSnapshot()" class="btn btn-primary">CREATE SNAPSHOT</button>
                </div>
                <div id="list-backups" style="overflow-y:auto; flex:1; border:1px solid var(--border); border-radius:8px;"></div>
            </div>
        </div>
    </div>

    <div id="terminal" style="display:none;">
        <div class="log-entry log-info">> SYSTEM INITIALIZED... WAITING FOR INPUT</div>
    </div>

    <div id="modal-ban" class="modal">
        <div class="card" style="width: 400px; border: 1px solid var(--red);">
            <h3 style="color:var(--red); margin-top:0;">INITIATE SANCTION</h3>
            <div style="margin-bottom:15px; font-size:0.9em;">TARGET: <span id="ban-target" style="color:white; font-weight:bold;"></span></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="number" id="t-hr" class="search-bar" placeholder="HOURS" style="margin:0">
                <input type="number" id="t-min" class="search-bar" placeholder="MINUTES" style="margin:0">
            </div>
            <input type="text" id="ban-reason" class="search-bar" placeholder="VIOLATION REASON">
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-ban')" class="btn btn-ghost" style="flex:1">ABORT</button>
                <button onclick="execBan()" class="btn btn-danger" style="flex:1">EXECUTE</button>
            </div>
        </div>
    </div>

    <script>
        let API="", KEY="", DB=[], LOGS=[];
        let TARGET_ID="";

        function log(msg, type="info") {
            let el = document.createElement('div');
            el.className = `log-entry log-${type}`;
            el.innerText = `> [${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('terminal').prepend(el);
        }

        // --- SYSTEM LOOP (Clock & Ping) ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0] + " UTC";
            document.getElementById('sys-ping').innerText = Math.floor(Math.random()*(40-15)+15) + " ms";
            if(KEY) fetchStats();
        }, 2000);

        setInterval(() => { document.getElementById('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0] + " UTC"; }, 1000);

        async function fetchStats() {
            try {
                let r = await fetch(API+'/api/stats', {headers:{'x-admin-auth':KEY}});
                let d = await r.json();
                if(d.success) {
                    document.getElementById('sys-uptime').innerText = new Date(d.uptime * 1000).toISOString().substr(11, 8);
                    document.getElementById('sys-ram').innerText = Math.floor(d.ram) + " MB";
                    document.getElementById('sys-status').innerText = "ONLINE";
                    document.getElementById('sys-status').style.color = "var(--green)";
                }
            } catch(e) {}
        }

        async function initSystem() {
            let u = document.getElementById('api-url').value.replace(/\/$/,"");
            let k = document.getElementById('api-pass').value;
            document.getElementById('login-msg').innerText = "HANDSHAKING...";
            
            try {
                let r = await fetch(u+'/api/players', {headers:{'x-admin-auth':k}});
                if(!r.ok) throw "INVALID CREDENTIALS";
                
                API=u; KEY=k; DB=(await r.json()).players;
                
                document.getElementById('login-screen').style.display='none';
                document.getElementById('telemetry').style.display='flex';
                document.getElementById('workspace').style.display='flex';
                document.getElementById('terminal').style.display='flex';
                
                log("UPLINK ESTABLISHED", "success");
                renderPlayers();
                updateIntegrity();

            } catch(e) { document.getElementById('login-msg').innerText = "CONNECTION REJECTED"; }
        }

        function updateIntegrity() {
            let total = DB.length;
            let banned = DB.filter(p=>p.isBanned).length;
            let pct = total === 0 ? 100 : Math.floor(((total-banned)/total)*100);
            
            document.getElementById('count-total').innerText = total;
            document.getElementById('count-ban').innerText = banned;
            document.getElementById('integrity-pct').innerText = pct + "%";
            document.getElementById('integrity-bar').style.width = pct + "%";
            document.getElementById('integrity-bar').style.background = pct < 50 ? "var(--red)" : "var(--green)";
        }

        function switchView(v) {
            document.getElementById('view-players').style.display = v==='players'?'flex':'none';
            document.getElementById('view-backups').style.display = v==='backups'?'flex':'none';
            if(v==='backups') loadBackups();
        }

        async function refreshData() {
            let r = await fetch(API+'/api/players', {headers:{'x-admin-auth':KEY}});
            DB = (await r.json()).players;
            renderPlayers(); updateIntegrity();
            log("DATABASE REFRESHED");
        }

        function renderPlayers() {
            let l = document.getElementById('list-players');
            let q = document.getElementById('p-search').value.toLowerCase();
            l.innerHTML = "";
            
            DB.filter(p => (p.username||"").toLowerCase().includes(q) || p.productUserId.includes(q)).forEach(p => {
                let status = p.isBanned ? `<span class="tag tag-red">BANNED</span>` : `<span class="tag tag-green">ACTIVE</span>`;
                let btn = p.isBanned 
                    ? `<button onclick="unban('${p.productUserId}')" class="btn btn-ghost">REVOKE</button>` 
                    : `<button onclick="openBan('${p.productUserId}','${p.username}')" class="btn btn-danger">BAN</button>`;
                
                l.innerHTML += `
                    <div class="row-item">
                        <div>
                            <div style="font-weight:bold; color:white;">${p.username||"UNKNOWN"}</div>
                            <div style="font-family:var(--font-code); font-size:0.8em; color:var(--dim);">${p.productUserId}</div>
                        </div>
                        <div style="display:flex; gap:15px; align-items:center;">
                            ${status} ${btn}
                        </div>
                    </div>`;
            });
        }

        async function loadBackups() {
            let l = document.getElementById('list-backups');
            l.innerHTML = "<div style='padding:20px; color:gray;'>FETCHING SNAPSHOTS...</div>";
            try {
                let r = await fetch(API+'/api/backups', {headers:{'x-admin-auth':KEY}});
                let data = (await r.json()).backups;
                l.innerHTML = "";
                data.forEach(b => {
                    let t = new Date(b.timestamp).toLocaleTimeString();
                    l.innerHTML += `
                        <div class="row-item">
                            <div>
                                <div style="color:var(--accent); font-weight:bold;">SNAPSHOT [AUTO]</div>
                                <div style="font-family:var(--font-code); font-size:0.8em; color:var(--dim);">${t}</div>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span style="font-size:0.8em; color:var(--dim)">DATA: ${b.totalPlayers} RECORDS</span>
                                <button onclick="restore('${b._id}')" class="btn btn-ghost" style="color:var(--accent); border-color:var(--accent)">RESTORE</button>
                                <button onclick="delSnap('${b._id}')" class="btn btn-danger">DEL</button>
                            </div>
                        </div>`;
                });
            } catch(e) { l.innerHTML = "ERROR"; }
        }

        async function createSnapshot() {
            log("INITIATING SNAPSHOT...");
            await fetch(API+'/api/backups/create', {method:'POST', headers:{'x-admin-auth':KEY}});
            log("SNAPSHOT COMPLETE", "success");
            loadBackups();
        }

        async function restore(id) {
            if(!confirm("WARNING: OVERWRITE DATABASE?")) return;
            log("RESTORING DATA...");
            let r = await fetch(API+'/api/backups/restore/'+id, {method:'POST', headers:{'x-admin-auth':KEY}});
            let d = await r.json();
            if(d.success) log(`RESTORE SUCCESS: ${d.count} RECORDS`, "success");
            else log("RESTORE FAILED", "warn");
        }

        async function delSnap(id) {
            if(!confirm("CONFIRM DELETION?")) return;
            await fetch(API+'/api/backups/'+id, {method:'DELETE', headers:{'x-admin-auth':KEY}});
            log("SNAPSHOT DELETED", "warn");
            loadBackups();
        }

        // BAN LOGIC
        function openBan(id, name) { TARGET_ID=id; document.getElementById('ban-target').innerText=name; document.getElementById('modal-ban').style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        async function execBan() {
            let h = parseInt(document.getElementById('t-hr').value)||0;
            let m = parseInt(document.getElementById('t-min').value)||0;
            let reason = document.getElementById('ban-reason').value;
            let mins = (h*60)+m;
            
            await fetch(API+'/api/ban', {
                method:'POST', headers:{'Content-Type':'application/json','x-admin-auth':KEY},
                body:JSON.stringify({productUserId:TARGET_ID, reason:reason, durationMinutes:mins})
            });
            closeModal('modal-ban'); refreshData(); log(`TARGET SANCTIONED: ${TARGET_ID}`, "warn");
        }

        async function unban(id) {
            if(confirm("REVOKE SANCTION?")) {
                await fetch(API+'/api/unban', {method:'POST', headers:{'Content-Type':'application/json','x-admin-auth':KEY}, body:JSON.stringify({productUserId:id})});
                refreshData(); log(`SANCTION REVOKED: ${id}`, "success");
            }
        }
    </script>
</body>
</html>
